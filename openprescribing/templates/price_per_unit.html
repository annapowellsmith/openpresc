{% extends "base.html" %}
{% load template_extras %}
{% load humanize %}

{% block title %}PPU savings for {{ entity.cased_name }}{% endblock %}
{% block active_class %}ccg{% endblock %}

{% block content %}

<h1>Top saving opportunities for {{entity.cased_name }} in {{ date|date:"F Y"}}</h1>

<div class="row">
  <div class="col-md-12">
    <p>There can be wide variation in the price paid across England for
    the same presentation of a drug or appliance. Every month we calculate
    the average price-per-unit (PPU) achieved by practices for each
    presentation. We then work out what {{entity.cased_name }} could save
      if it were prescribing as well as the best 10%. </p>

    {% if by_presentation %}
     <h3>Focus on savings for {{ presentation.product_name }}
     </h3>
      <p>
       The following chart shows prescribing on all brands and formulations of <span id="extended-info-link">{{ presentation.product_name }}</span>{% if entity.code|length == 3 %}, for all practices within {{ entity.cased_name }}.  Data for individual practices is displayed below the chart.{% else %}  for {{ entity.cased_name }}; the summary data is displayed below the chart.{% endif %}
       {% if highlight %}
         Alternatively, you can <a href="{% url 'ccg_price_per_unit' highlight %}?date={{ date|date:"Y-m-d" }}">remove focus on {{ presentation.product_name }}.</a>
       {% endif %}
      </p>
    {% else %}
     <p>Click on a presentation name to drill down.</p>
    {% endif %}
     <div id="extended-info">
      <h4>Extended information about {{name}}</h4>
      <div id="extended-info-content">
      {% if product %}
       <table class="table table-condensed">
         <tr>
           <th>Tariff category <super style="color:red">*</super></th>
           <td>{{ product.tariff_category }}</td>
         </tr>
         <tr>
           <th>Availability restrictions (special, imported, etc)</th>
           <td>{{ product.availability_restrictions }}</td>
         </tr>
         <tr>
           <th>Prescribability status (non-bioequivalence, etc)</th>
           <td>{{ product.prescribability }}</td>
         </tr>
       </table>
      {% else %}
       <p>
         Extended information from dm+d not available for this presentation.
       </p>
       {% endif %}
       </div>
     </div>
  </div>
</div>

{% if by_presentation %}
<div class="row">
  <div class="col-md-12">
  {% include '_bubble_chart.html' %}
  </div>
</div>
{% endif %}

<div class="row">
  <div class="col-md-12">
{% include '_ppu_data_table.html' %}
  </div>
</div>

<h2>Explanatory notes</h2>

<h3>Interpretation</h3>
<p>This model assumes that every practice could achieve the same value for money as the practice at the 10th percentile. In general, if pill <strong>A1</strong> is expensive and pill <strong>A2</strong> is cheap, the savings could be achieved by switching to prescribing as much as possible of pill <strong>A2</strong>.</p>
<p>We don't identify <strong>A2</strong> on your behalf, because there may be many reasons why particular switches might not make sense (see <em>Limitations</em>, below).</p>
<p>We do, however, provide charts for each presentation which show the distribution of different PPUs for all brands that have been prescribed in a given month. This can help identify brands (or generics) to which it might make sense to switch.</p>

<h3>Method</h3>
<p>Within a single month, we calculate the average PPU achieved by each practice for each presentation (generic and branded combined). We then approximate a realistic, best-case PPU by finding the average PPU which is at the cheapest decile for that presentation.</p>

<p>We then work out what each GP Practice or CCG could save if it prescribed that presentation at the best decile.</p>

<ul>
  <li>We only consider data from a single month, because the Drug Tariff changes monthly, making price-per-dose comparisons meaningless between months</li>
  <li>We cover data from standard GP Practices only</li>
  <li>When summing total possible savings, for a given practice or CCG, we don't consider savings that they are already making</li>
  <li>We use the NIC cost rather than the actual cost for these calculations (see below)</li>
  <li>When calculating PPU, we combine all formulations (e.g. tablets and capsules) that we consider to be clinically equivalent.</li>
</ul>

<h3>Limitations</h3>
<ul>
<li>Cost-saving opportunities are calculated on the basis of <em>Net Ingredient Cost</em> (NIC). We use NIC because it excludes container payments, bulk discounting and out-of-pocket expenses. This allows our calculations to be consistent across NHS England; however, this approach will, on average, overestimate possible savings by around 7%.</li>

<li>Some theoretical switches may not be advisable due to the non-bioequivalence of different brands.  We have marked presentations with non-bioequivalence issues with a warning sign <span class="glyphicon glyphicon-warning-sign" style="color:red"></span>.  Licencing differences may also play a role.</li>

<li>This analysis is carried out against GP Practice prescribing data for NHS England, which typically has a 3 month lag to its release.  If the Department of Health has updated the Drug Tariff to reflect the cheaper list prices, then a switch may no longer be necessary to achieve savings.</li>

<li>For a full discussion of our approach, including further limitations and discussion of the issues, see our <a href="https://github.com/ebmdatalab/price-per-dose">code repository</a>.  We are also in the process of writing a paper on the subject, which we will refer to here when it's published.</li>
</ul>



{% endblock %}

{% block extra_js %}
{% conditional_js 'bubble' %}
  <script>
    var bubble_data_url = '{{ API_HOST }}/api/1.0/bubble/?format=json&bnf_code={{ bnf_code }}&highlight={{ highlight }}&date={{ date|date:"Y-m-d" }}&trim={{request.GET.trim}}';
    var highlight_name = '{{ highlight_name }}';
    var generic_name = '{{ name }}';
    $('#price_per_pill .info-link').popover();
    {% if product %}
     $('#extended-info-link').popover({
       html: true,
       trigger: 'click focus',
       content: function() {
         return $('#extended-info-content').html();
       },
       title: function() {
         return $('#extended-info h2').html();
       }
     }).addClass('info-link');
    {% endif %}

  </script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs-3.3.7/dt-1.10.15/datatables.min.css"/>

<script type="text/javascript" src="https://cdn.datatables.net/v/bs-3.3.7/dt-1.10.15/datatables.min.js"></script>
<script type="text/javascript">
  {% if by_presentation %}
    // When viewing at Presentation level, link back to practice-level
    var first_column = 'practice_name';
    var first_column_render = function(data, type, full, meta) {
      return ' <a href="/practice/'+full['practice']+'/price_per_unit/?date='+ full['date']+ '">'+full['practice_name']+'</a>';
      return link;
    }
  {% elif by_ccg %}
    // When viewing at CCG level, drill down to practices
    var first_column = 'presentation';
    var first_column_render = function(data, type, full, meta) {
      return ' <a href="/ccg/{{ entity.code }}/'+data+'/price_per_unit/?date='+ full['date']+ '">'+full['name']+'</a>';
    }
  {% else %}
    // When viewing at Practice level, group up to CCG
    var first_column = 'name';
    var first_column_render = function(data, type, full, meta) {
      return '<a href="/practice/'+full['practice']+'/'+full['presentation']+'/price_per_unit/?date='+ full['date']+ '">'+data+'</a>';
    }
  {% endif %}

  $('#price_per_pill').DataTable(
    {
      "dom": '<"top"f>rt<"bottom"lip><"clear">',
      "ajax": {"url": "{{ API_HOST }}/api/1.0/price_per_unit/?entity_code={{ entity.code }}&date={{ date|date:'Y-m-d' }}&bnf_code={{ bnf_code }}&format=json", "dataSrc": ""},
      "order": [[1, "desc"]],
      "columns": [
        {"data": first_column,
         "render": first_column_render
        },
        {"data": "possible_savings", render: $.fn.dataTable.render.number(',', '.', 2, '£' )},
        {"data": "price_per_unit", render: $.fn.dataTable.render.number(',', '.', 2, '£' )},
        {"data": "lowest_decile", render: $.fn.dataTable.render.number(',', '.', 2, '£' )},
        {"data": "quantity", render: $.fn.dataTable.render.number(',')},
        {"data": "formulation_swap", "defaultContent": "-"},
      ]
    }
  );
</script>
{% endblock %}
